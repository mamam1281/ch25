# 2025-12-14 변경 로그

## 1. 프론트엔드 API 경로 수정 (Critical Fix)

### 문제
- 프론트엔드에서 `/auth/token`, `/dice/status` 등으로 호출 → 404
- 백엔드 라우터는 `/api/auth`, `/api/dice` 등으로 prefix 설정됨
- VITE_API_URL에 `/api`가 붙어있어 `/api/api/...` 중복 발생

### 해결
**환경변수 수정** (서버 `.env` 파일들):
```bash
# Before
VITE_API_URL=http://149.28.135.147:8000/api

# After
VITE_API_URL=http://149.28.135.147:8000
```

**API 호출 경로 수정** (6개 파일):
| 파일 | Before | After |
|------|--------|-------|
| `src/api/authApi.ts` | `/auth/token` | `/api/auth/token` |
| `src/api/diceApi.ts` | `/dice/status`, `/dice/play` | `/api/dice/status`, `/api/dice/play` |
| `src/api/lotteryApi.ts` | `/lottery/status`, `/lottery/play` | `/api/lottery/status`, `/api/lottery/play` |
| `src/api/rouletteApi.ts` | `/roulette/status`, `/roulette/play` | `/api/roulette/status`, `/api/roulette/play` |
| `src/api/rankingApi.ts` | `/ranking/today` | `/api/ranking/today` |
| `src/api/seasonPassApi.ts` | `/season-pass/*` | `/api/season-pass/*` |

---

## 2. 팀배틀 시즌 시간대 이슈 (Critical Fix)

### 문제
- MySQL `NOW()`가 KST(Asia/Seoul) 시간을 반환
- 백엔드 `_normalize_to_utc()`가 naive datetime을 UTC로 가정
- `ends_at = 2025-12-14 14:59:59` (UTC 의도) vs `NOW() = 15:15:25` (KST)
- 결과: 시즌이 만료된 것으로 판정 → API가 `null` 반환

### 해결
```sql
-- ends_at을 충분히 큰 값으로 설정 (백엔드가 KST로 해석 → UTC 변환)
UPDATE team_season 
SET ends_at = '2025-12-14 23:59:59' 
WHERE id = 1;
```

### 근본 원인 (향후 개선 필요)
- MySQL 서버 시간대가 KST로 설정됨
- 백엔드 `_normalize_to_utc()` 로직이 naive datetime 처리 시 혼란
- **권장**: MySQL 서버를 UTC로 설정하거나, 모든 datetime에 timezone 명시

---

## 3. 팀배틀 기여도 닉네임 표시 (Enhancement)

### 문제
- 어드민 팀배틀 페이지에서 기여자 목록에 "닉네임 없음"으로 표시
- `contributors` API가 `user_id`만 반환, `nickname` 미포함

### 해결
**스키마 수정** (`app/schemas/team_battle.py`):
```python
class ContributorEntry(BaseModel):
    user_id: int
    nickname: str | None = None  # 추가
    points: int
    latest_event_at: datetime | None = None
```

**서비스 수정** (`app/services/team_battle_service.py`):
```python
def contributors(self, db: Session, team_id: int, ...):
    from app.models.user import User
    # ...
    stmt = (
        select(TeamMember.user_id, User.nickname, points_sum, latest_event)
        .join(User, User.id == TeamMember.user_id)  # User JOIN 추가
        # ...
        .group_by(TeamMember.user_id, User.nickname)  # GROUP BY에 nickname 추가
    )
```

**라우트 수정** (`app/api/routes/team_battle.py`):
```python
return [
    ContributorEntry(
        user_id=r.user_id,
        nickname=getattr(r, "nickname", None),  # 추가
        points=r.points or 0,
        latest_event_at=getattr(r, "latest_event_at", None),
    )
    for r in rows
]
```

---

## 4. 디스크 공간 부족 해결 (Ops)

### 문제
```
ERROR: No space left on device
Container xmas-db is unhealthy
```

### 해결
```bash
docker system prune -a -f
docker volume prune -f
docker builder prune -a -f
```

---

## 5. 변경된 파일 목록

### 프론트엔드
- `src/api/authApi.ts` - /api prefix 추가
- `src/api/diceApi.ts` - /api prefix 추가
- `src/api/lotteryApi.ts` - /api prefix 추가
- `src/api/rouletteApi.ts` - /api prefix 추가
- `src/api/rankingApi.ts` - /api prefix 추가
- `src/api/seasonPassApi.ts` - /api prefix 추가

### 백엔드
- `app/schemas/team_battle.py` - ContributorEntry에 nickname 필드 추가
- `app/services/team_battle_service.py` - contributors 쿼리에 User JOIN 추가
- `app/api/routes/team_battle.py` - ContributorEntry 응답에 nickname 포함

### 환경변수 (서버)
- `.env` - VITE_API_URL에서 /api 제거
- `.env.production` - VITE_API_URL에서 /api 제거
- `.env.production.vite` - VITE_API_URL에서 /api 제거
- `.env.frontend.production` - VITE_API_URL에서 /api 제거

---

## 6. 향후 개선 과제

### 우선순위 높음
1. **MySQL 시간대 통일**: 서버를 UTC로 설정하거나 connection에서 timezone 명시
2. **시즌 관리 UI**: 어드민에서 시즌 생성/연장 기능 개선

### 우선순위 중간
3. **리더보드 member_count**: 현재 0으로 표시되는 문제 확인 필요
4. **팀 멤버 수 표시**: leaderboard API에서 member_count가 제대로 집계되는지 확인

### 우선순위 낮음
5. **docker-compose.yml**: `version` 속성 제거 (deprecated warning)
6. **비밀번호 노출 경고**: MySQL 접속 시 `-p` 옵션 대신 환경변수 사용

---

## 7. 배포 명령어 요약

```bash
# 프론트엔드 재빌드
docker compose build frontend --no-cache
docker compose up -d --force-recreate frontend

# 백엔드 재빌드
docker compose build backend --no-cache
docker compose up -d --force-recreate backend

# 팀배틀 시즌 연장 (필요시)
docker compose exec db mysql -uxmasuser -p'2wP?+!Etm8#Qv4Mn' xmas_event \
  -e "UPDATE team_season SET ends_at = '2025-12-15 23:59:59' WHERE id = 1;"

# 디스크 정리 (긴급시)
docker system prune -a -f && docker builder prune -a -f
```
