# 개발 로그: Telegram Link Code 시스템 (2024-12-31)

## 변경 요약
Telegram `start_param` 길이 제한 문제를 해결하기 위해 JWT 기반 토큰 대신 **12자리 Base62 단축 코드** 시스템으로 전환.

---

## 주요 변경 파일

### [NEW] `app/models/telegram_link_code.py`
- `TelegramLinkCode` SQLAlchemy 모델 생성
- 컬럼: `code` (PK, 16자), `user_id`, `expires_at`, `used_at`, `created_at`, `client_ip`, `user_agent`

### [MODIFY] `app/api/routes/telegram.py`
- **`POST /link-token`**: 
  - 기존: `security.create_telegram_link_token()` → JWT 생성
  - 변경: `_generate_short_code(12)` → DB에 저장 → `link_<code>` 반환
  
- **`POST /auth`**:
  - 기존: `security.decode_telegram_link_token()` → JWT 검증 + User.nonce 검사
  - 변경: `TelegramLinkCode` 테이블 조회 (with `FOR UPDATE`) → `used_at` 마킹 → 연결

### [NEW] `scripts/create_telegram_link_code.sql`
- MySQL 테이블 생성 스크립트 (적용 완료)

---

## 보안 개선 사항
| 항목 | 기존 | 변경 후 |
|------|------|---------|
| 코드 길이 | ~200자 (JWT) | 12자 (Base62) |
| 저장소 | User.nonce 컬럼 | 별도 `telegram_link_code` 테이블 |
| 동시성 처리 | 없음 | `SELECT FOR UPDATE` 사용 |
| 사용 표시 | nonce 삭제 | `used_at` 타임스탬프 기록 |
| 만료 에러 | 400 Bad Request | 410 Gone (명확한 상태 코드) |

---

## 다음 단계 (미구현)
- [x] **Admin Merge Tool**: 중복 계정 병합 API 및 스크립트 ✅
- [x] **연결 해제 요청 워크플로우**: 409 충돌 시 사용자 자기주장 검증 절차 ✅
- [ ] **Cleanup Job**: 만료된 미사용 코드 정리 배치

---

## [2024-12-31 추가] Admin Merge Tool

### 파일
- `app/api/routes/admin_user_merge.py`

### 기능
- `POST /api/admin/user/merge/dry-run`: 병합 영향도 미리보기
- `POST /api/admin/user/merge/execute`: 트랜잭션으로 병합 실행

### 병합 동작
1. Balance 합산 (cash, vault_locked)
2. Telegram ID 이전 (target에 없을 경우)
3. FK 재할당 (game_wallet, ledger, mission_progress 등)
4. Source user → status='MERGED' 표시

---

## [2024-12-31 추가] Unlink Request Workflow

### 파일
- `app/models/telegram_unlink_request.py`
- `app/api/routes/telegram_unlink.py`

### API
| Endpoint | 설명 |
|----------|------|
| `POST /api/telegram/unlink-request` | 사용자가 연결 해제 요청 제출 |
| `GET /api/admin/telegram/unlink-requests` | 관리자: 요청 목록 조회 |
| `POST /api/admin/telegram/unlink-requests/{id}/process` | 관리자: 승인/거절 처리 |

### 플로우
1. 사용자가 409 오류 수신 → 연결 해제 요청 제출
2. 관리자가 evidence 검토 → 승인 시 telegram_id 해제
3. 요청자는 정상 연동 플로우 재시도 가능

---

## 검증 항목
- [x] `telegram_link_code` 테이블 생성 확인 (MySQL)
- [x] `telegram_unlink_request` 테이블 생성 확인 (MySQL)
- [ ] `/link-token` API 테스트 (짧은 코드 반환)
- [ ] `/auth` API 테스트 (코드 검증 및 연결)
- [ ] 만료/중복 사용 시나리오 테스트
- [ ] Merge dry-run 및 execute 테스트
