# 팀 배틀 리텐션 강화(기여 피드백/역전·열세 알림) 설계안

**작성일:** 2025-12-19

## 목표
- 팀 배틀에서 “내가 기여했다”는 즉각적 피드백을 제공해 경쟁의 맛(도파민)을 강화한다.
- “우리 팀이 지고 있다”/“역전했다” 같은 상태 변화를 명확히 알려 재방문 동기를 만든다.

## 제약(현재 프로젝트 조건)
- **백엔드/API/DB 변경 없이** 구현 가능해야 한다.
- 현행 팀 배틀 API에서 제공되는 데이터만 사용한다.
- 알림(푸시) 같은 OS 레벨 트리거는 제외하고, **웹 내(in-app) 토스트/배너** 중심으로 설계한다.

## 현재 사용 가능한 데이터(프론트 기준)
- `/api/team-battle/seasons/active` → `TeamSeason`: 시즌 기간(ends_at)
- `/api/team-battle/teams/me` → `TeamMembership | null`: `team_id`
- `/api/team-battle/teams/leaderboard` → `LeaderboardEntry[]`: `team_id`, `team_name`, `points`, `latest_event_at?`

> 참고: 현재 타입에 “내 개인 기여도(points)”는 없음. 개인 기여도 기반 피드백을 정확히 하려면 `/contributors`를 추가 조회하거나(이미 API 존재) UI에서 팀 점수 변화로 대체해야 함.

## 핵심 UX 구성

### 1) 열세 알림(“우리 팀이 지고 있다”)
**노출 타이밍(권장)**
- 사용자가 `/team-battle` 진입 시, 리더보드 로드 후 1회 평가.
- 이후 60초 리패치마다 상태 변화를 평가(스팸 방지 로직 필요).

**판정 로직(프론트만으로 가능한 최소안)**
- `leaderboard`에서 내 팀(`myTeam.team_id`)의 `points`와 1위 팀의 `points` 비교
  - 내 팀이 1위가 아니면 `behindBy = top.points - my.points` 계산
  - `behindBy >= 임계치`일 때만 강하게 노출(예: 50점/100점). 임계치는 운영 테스트로 튜닝

**UI 형태(단순/효과적)**
- 메인 패널 상단에 얇은 배너(예: "지금 우리 팀이 2위예요 · 1위와 120점 차")
- CTA는 기존 행동으로 연결: "게임하러 가기"(룰렛/주사위/복권) 또는 "새로고침" 버튼

**스팸 방지**
- `sessionStorage`에 `teamBattle.behindBanner.shown.<seasonId>` 저장
  - 같은 세션에서 과도하게 반복 노출 방지

### 2) 역전/순위 변동 알림(“역전했다”, “추격 중”)
**목표**
- 팀 점수/순위 변화가 생겼을 때, 사용자에게 ‘팀 경쟁이 살아있다’를 체감시키기.

**판정 로직(프론트만으로 가능)**
- 로컬 저장소에 직전 스냅샷 저장
  - 키: `localStorage['teamBattle.snapshot.<seasonId>.<teamId>']`
  - 값: `{ points, rank, capturedAt }`
- 새 데이터 로드 후 비교
  - rank가 개선(예: 3위→2위)되면: "역전! 우리 팀이 2위로 올라왔어요"
  - points가 증가하면: "우리 팀 점수 +X (현재 Y점)"

**노출 방식**
- `useToast().addToast`로 1~2줄 토스트
- 같은 변화에 대한 중복 노출 방지(예: capturedAt, points 비교로 1회)

### 3) “내 기여” 피드백(정확도 옵션 2가지)

#### 옵션 A(정확도 높음): Contributors 조회 추가
- API는 이미 존재: `/api/team-battle/teams/{teamId}/contributors`
- 사용자 본인 `user_id`를 알 수 있는 경로가 있으면(예: auth profile), 내 `points` 변화 추적 가능
- 장점: “내가 올린 점수”를 정확히 보여줄 수 있음
- 단점: 현재 페이지에 추가 쿼리 1개(성능/로딩 관리 필요), user_id 접근 경로 확인 필요

#### 옵션 B(정확도 중간/구현 최소): 팀 점수 증가를 ‘기여’로 간주
- 사용자가 팀배틀 페이지에 머무르는 동안 팀 점수가 증가하면 "방금 팀 점수가 올랐어요!"로 피드백
- 장점: 추가 API 없이 가능
- 단점: 내가 올린 것인지 팀원이 올린 것인지 구분 불가(문구를 중립적으로 써야 함)

**권장 문구(옵션 B 기준)**
- "우리 팀 점수가 올랐어요 (+X)" / "지금 추격 중입니다"
- ‘내가 올렸다’ 단정은 피한다.

## 구현 범위 제안(현재 코드에 자연스럽게 넣는 위치)
- [src/pages/TeamBattleFigmaPage.tsx](src/pages/TeamBattleFigmaPage.tsx) 안에서
  - `leaderboardQuery.data` 및 `myTeamQuery.data` 준비된 시점에
  - (1) 열세 배너 상태 계산
  - (2) 로컬 스냅샷 비교 후 토스트 발행
  - (3) 스냅샷 저장

## 수치/임계치(초기 추천)
- 열세 배너 임계치: `behindBy >= 100` 일 때 강한 문구
- 역전 토스트: rank 개선 시 항상 1회
- 점수 증가 토스트: `deltaPoints >= 50`일 때만(스팸 방지)

## 운영/측정(선택)
- 토스트/배너 노출 횟수, 클릭(CTA) 횟수만이라도 로깅하면 튜닝이 빨라짐.
- 단, 현재 프로젝트에서 로그 수집 체계가 없으면 제외.

## 다음 확인 필요(짧은 체크리스트)
1) 내 `user_id`를 프론트에서 안정적으로 얻을 수 있는가? (가능하면 옵션 A로 “내 기여도” 정밀화)
2) leaderboard가 팀 2~3개만인지, 더 많은 팀이 있는지(순위 로직 영향)
3) points 증가 빈도(60초 리패치 기준 스팸 여부)
