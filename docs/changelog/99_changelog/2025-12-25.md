- 문서 타입: 변경 로그
- 버전: v1.1
- 작성일: 2025-12-25
- 작성자: AI Agent
- 대상 독자: DevOps, BE 개발자

# 2025-12-25 통합 변경 로그

## 요약
- 12/14 API 경로/시간대 치명적 이슈 수정부터 12/21 팀배틀·Vault Phase 1 전환, 12/25 시즌 브리지 문서 최신화까지 연속 작업을 통합.
- **[New]** 운영 서버(149.28.135.147) SSL 인증서 발급 오류 해결 및 배포 정상화 완료.

## 주요 추가/변경 (날짜순 압축)
- **12/14**
  - 프론트 API prefix 불일치(Critical) 수정: VITE_API_URL에서 `/api` 제거, 모든 API 호출 경로 `/api/*`로 정규화.
  - 팀배틀 시즌 시간대 오판(Critical) 핫픽스: `team_season.ends_at` 상향 조정(KST↔UTC 혼선 임시 조치), DB 시간대/naive 처리 개선 필요 사항 남음.
  - 팀배틀 기여도 응답에 nickname 포함(User JOIN), 디스크 여유 확보.
- **12/19**
  - UX 집중 업데이트: 게임 3종 즉시 재시도/햅틱/애니메이션, 게임·시즌패스·팀배틀 레이아웃/라우팅 재정비, 팀배틀 Figma 뷰와 네비 링크 개선.
- **12/20**
  - 시즌패스 “오늘 스탬프”를 진짜 일일 체크인(YYYY-MM-DD)으로 강제, 중복 차단(`ALREADY_STAMPED_TODAY`).
  - 로컬 테스트 환경 정리(PyJWT 누락, Python 3.11 venv)로 `pytest` 실행 복구.
- **12/21**
  - 팀배틀 Figma UI 복구 + 미스터리 팀 배정(join window 24h) 실동작 연결, 시즌 데이터 실측 검증.
  - GuidePage 캐시 불일치 해결: nginx에서 SPA shell no-cache 적용, 빌드 해시 갱신 확인 절차 추가.
  - Ticket Zero UX: `app_ui_config`(admin/ui-config)로 문구/CTA 실시간 운영, 공용 `TicketZeroPanel` 도입, 자동 체험 지급(일 1회) 연동.
  - Vault Phase 1: `user.vault_locked_balance` 단일 기준 전환, `vault_balance` legacy mirror 동기화, external_ranking는 신호만 보내고 해금은 VaultService로 일원화. 마이그레이션 `20251221_0026` 적용 및 테스트/E2E 갱신.
  - 도커 전 서비스 재빌드 + `alembic upgrade head`로 DB 스키마 정합성 복구.
- **12/25**
  - **Server SSL/Deployment Fix**:
    - SSL 발급 실패(Chicken-and-Egg) 해결: `init_ssl.sh` 스크립트 작성 (Dummy Cert 발급 → Nginx 시작 → Certbot Valid Cert 발급 → Reload).
    - `www.cc-jm.com` DNS 미등록 확인 → `cc-jm.com` 단일 도메인으로 인증서 발급 변경.
    - Docker Compose v2.24.0 업그레이드 (서버 내 구버전 호환성 문제 해결).
    - 권한 문제 해결: `/var/www/certbot` 권한 777 부여로 Challenge 파일 접근 허용.
    - 최종 배포 확인: `alembic upgrade head` 성공 (Head: `20251225_0006`), `https://cc-jm.com` 접속 정상화.
  - 시즌 브리지(12/25~12/31, 7-key → 1/1 배치 지급) 문서 최신화: overview/architecture/API/DB/Ops, user 임시 컬럼(`event_key_count`, `event_pending_points`), `season_pass_stamp_log.event_type=KEY_DAY_1~7`, 런북 배치 검증 추가.
  - **Mixed Content Error 완전 해결 (21:00~21:30)**:
    - 문제: 어드민 페이지(`https://cc-jm.com/admin/seasons`)에서 API 요청이 `http://`로 전송되어 브라우저 Mixed Content 정책에 의해 차단.
    - 원인: `src/admin/api/httpClient.ts`와 `src/api/httpClient.ts`에서 `window.location.origin`을 사용하여 절대 경로를 생성했으나, 프로토콜이 명시적으로 HTTPS로 강제되지 않음.
    - 해결: 운영 환경(non-localhost)에서는 **상대 경로(`/admin/api`, `/api`)** 사용으로 전환. Nginx 리버스 프록시가 현재 접속 프로토콜(HTTPS)을 자동 유지하도록 수정.
    - 영향: 어드민 페이지의 모든 설정 기능(시즌 관리, UI 설정 등) 정상 작동 확인.
  - **시즌패스 브릿지 시즌 생성 및 보상 정책 구현 (20:50~21:30)**:
    - **DB 작업**: 
      - 기존 시즌(12/24 종료) 비활성화 후 새 시즌 `연말 브릿지 시즌 (12/25-1/1)` 생성 (ID: 3, `is_active=1`).
      - 10개 레벨 보상 데이터 삽입 (`insert_season.sql` 스크립트 작성 및 실행).
    - **보상 지급 정책 정밀화**:
      - **자동 지급 (`auto_claim=1`)**: 룰렛/다이스/복권 티켓 등 내부 재화 (Level 1~6).
      - **관리자 수동 지급 (`auto_claim=0`)**: CC 포인트, CC 코인, Gold/Diamond Key 등 외부 플랫폼 재화 및 고가치 아이템 (Level 7~10).
      - UI 로직 개선: `SeasonPassRewardsAndTasks.tsx`에서 보상 타입 자동 감지 로직 추가 (`/CC\s*(포인트|코인|POINT|COIN)/i`, `/KEY/i` 정규식 매칭).
      - 관리자 지급 대상은 UI에 **"관리자 지급"** 배지 표시 및 **"관리자 확인 후 외부 지급됩니다"** 안내 문구 노출.
  - **Vault(금고) 로직 업데이트**:
    - 입금 기반 해금 로직 완전 비활성화 (`vault_service.py` Line 336-346 주석 처리).
    - UI 카피 변경: "게임 플레이 시 포인트가 금고에 적립되며, 이용 내역 확인 시 보유 머니로 전환됩니다."
    - `VaultMainPanel.tsx`, `VaultModal.tsx`에서 입금 관련 CTA 및 안내 제거, 게임 플레이 기반 적립 강조.
  - **운영 기획 문서 작성**:
    - `docs/06_ops/20251225_detailed_operation_strategy.md`: 12/25~1/1 브릿지 주간 상세 운영 전략 (신규/기존 유저 타겟팅, 일자별 체크리스트, 보상 지급 매뉴얼 포함).
    - `docs/06_ops/20251225_operation_plan_bridge_week.md`: 간략 운영 기획안 (KPI, 모니터링 포인트 포함).
  - **Git 기반 배포 워크플로우 확립 (21:10~21:30)**:
    - 로컬 변경사항 커밋: `feat: Introduce Season Pass with rewards and tasks UI, initial bridge season data, and new API clients.` (commit: `ecca2f1`).
    - 서버 배포: `ssh` → `git restore .` → `git pull origin as` → `docker-compose up -d --build frontend backend`.
    - 빌드 완료 확인: Frontend (Vite 빌드 1분 48초), Backend (Python 패키지 설치 및 이미지 생성).
    - 최종 상태: 모든 컨테이너(Frontend, Backend, DB, Redis, Nginx) 정상 가동 확인.

## 빠진 것 / 추가로 챙길 것
- **시간대/UTC 정리**: 12/14 팀배틀 ends_at 핫픽스는 임시. DB/애플리케이션 TZ 일원화 또는 모든 datetime TZ 명시 필요.
- **팀배틀 데이터 정리**: 활성 팀만 보이도록 기존 팀 데이터 비활성/정리 정책 확정 필요(12/21 메모).
- **member_count/리더보드 정확도**: 12/14/12/21 로그에서 언급된 인원/카운트 검증 및 API 집계 확인 필요.
- **Vault Phase 1 후속**: locked→available 상태머신 행동 변경 적용 전, 운영 데이터 점검/모니터링 포인트 확정.
- **GuidePage/정적 캐시**: nginx no-cache 설정 유지 확인, CI/CD 캐시 정책 점검 필요 시 재검토.
- **일일 스탬프 UI 트리거**: 12/20 변경(일일 키만 인정)에 맞춰 UI 버튼/트리거 노출이 제품 의도에 부합하는지 결정.

## 연관 파일/마이그레이션
- Backend: `20251221_0026_add_vault_phase1_locked_columns.py`, VaultService/RewardService/ExternalRanking 관련 변경.
- Frontend: 게임/시즌패스/팀배틀 라우트 및 TicketZeroPanel, haptics/AnimatedNumber 등 UI 개선.
- Docs: 시즌 브리지/금고×체험티켓 경계 업데이트(overview/architecture/API/DB/Ops/changelog).
- Infra/Ops: nginx 캐시 설정(index.html no-store), `alembic upgrade head` 필수.
