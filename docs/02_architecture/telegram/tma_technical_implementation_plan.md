# 텔레그램 미니앱(TMA) 기술 개발 상세 설계서

이 문서는 텔레그램 플랫폼의 강점을 극대화하여 사용자 리텐션과 소셜 확산성을 높이기 위한 신규 기능들의 기술적 구현 방안을 정의합니다.

---

## 1. 백엔드 봇 인게이지먼트 (Notification & Menu)

봇을 단순한 앱 입구가 아닌, 능동적인 게임 관리자로 전환합니다.

### 1-1. 개인화 푸시 알림 시스템
*   **기술적 구현**: 
    *   **Backend**: `APScheduler` 또는 `Celery`를 사용하여 비동기 작업 큐 구축.
    *   **Logic**: `User` 테이블에 `telegram_chat_id` 필드 추가.
    *   **Trigger**:
        *   **쿨타임 종료**: 복권/룰렛 무료 참여 기회 갱신 시 봇이 `sendMessage` 호출.
        *   **순위 변동**: 팀 배틀에서 본인 팀의 순위가 바뀌거나 역전당할 때 즉시 알림.
*   **API**: `https://api.telegram.org/bot<token>/sendMessage`

### 1-2. 커스텀 메뉴 버튼 (Menu Button)
*   **구현**: 봇 프로필 하단의 기본 'Start' 버튼을 '2026 플레이하기' 텍스트와 앱 아이콘으로 상시 고정.
*   **API**: 봇 초기화 스크립트에서 `setChatMenuButton` 호출.

---

## 2. 네이티브 UI 통합 (Native Feedback)

브라우저의 이질감을 제거하고 텔레그램 네이티브 경험을 선사합니다.

### 2-1. 네이티브 확인창 (Confirm/Alert)
*   **구현**: `window.confirm` 대신 `tg.showConfirm` 사용.
*   **적용 포인트**:
    *   티켓 소모 전 최종 확인.
    *   팀 탈퇴/변경 시 경고창.

### 2-2. 커스텀 팝업 (Popup API)
*   **구현**: `tg.showPopup`을 사용하여 최대 3개의 버튼(예: "확인", "상점으로 이동", "닫기")을 가진 다중 선택창 구현.
*   **특징**: 텔레그램 테마와 100% 일치하는 UI 제공.

---

## 3. 소셜 확산 및 공유 (Deep Sharing)

사용자가 스스로 콘텐츠를 생산하고 전파하게 만듭니다.

### 3-1. 결과 직접 공유 (Share API)
*   **구현**: `tg.shareToChat` 또는 `switchInlineQuery`를 통해 당첨 결과를 정형화된 카드 형태로 전송.
*   **UI**: "대박! 방금 10,000 포인트 당첨됨. 너도 해봐" 문구와 앱 링크 자동 삽입.

### 3-2. 텔레그램 스토리(Stories) 연동
*   **구현**: 당첨 결과 화면에 '스토리에 공유' 버튼 배치. `tg.shareToStory` API를 통해 결과를 이미지/영상과 함께 텔레그램 스토리에 업로드.

---

## 4. 클라우드 스토리지 (Cloud Storage API)

서버 DB 부하를 줄이면서 사용자 편의성을 높입니다.

*   **구현**: 텔레그램 서버에 사용자별 키-값 쌍 저장 (`CloudStorage` 인터페이스).
*   **저장 항목**:
    *   `sound_enabled`: 사운드 온/오프 상태.
    *   `tutorial_completed`: 최초 튜토리얼 확인 여부.
    *   `last_selected_tab`: 룰렛/복권에서 마지막으로 이용한 탭 정보.
*   **장점**: 서버 API 호출 없이 클라이언트 사이드에서 즉시 데이터 동기화.

---

## 5. 채널/그룹 도구 (Guild Integration)

커뮤니티와 게임을 실시간으로 연결합니다.

### 5-1. 실시간 채널 메시지 전광판
*   **기술**: 공식 공지 채널의 최신 메시지를 백엔드에서 래핑하여 프론트엔드 전광판(Ticker)에 실시간 노출.
*   **효과**: 앱을 닫지 않고도 공지사항과 커뮤니티 반응 확인 가능.

### 5-2. 길드 전용 미니 채널 연동
*   **구현**: 각 팀(Team)별로 연결된 텔레그램 그룹/채널로 이동하는 숏컷 버튼 제공.

---

## 🛠 단계별 개발 로드맵

### Phase 1: Native UX 강화 (1-2일)
*   `SoundProvider` 등에 `CloudStorage` 연동.
*   주요 동작에 `showConfirm`, `showPopup` 적용.
*   메뉴 버튼 커스텀 설정.

### Phase 2: 소셜 확산 도구 (2-3일)
*   복권/룰렛 결과 화면에 '직접 공유' 및 '스토리 공유' 기능 추가.
*   공유 시 사용할 템플릿(이미지/링크) 최적화.

### Phase 3: 백엔드 푸시 & 채널 연동 (3-5일)
*   스케줄러 기반 알림 봇 연동.
*   채널 메시지 스크래핑/API 연동 및 인앱 전광판 구현.

---

> [!IMPORTANT]
> 본 설계는 텔레그램 **Bot API 7.0+** 명세를 기준으로 하며, 최신 버전의 텔레그램 앱에서 가장 최적화된 성능을 발휘합니다.
