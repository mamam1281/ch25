# 2026-01-03 개발 로그: 주사위(DICE) 보상/금고 정합성 + 운영 UX 정리

## TL;DR (주사위 핵심)
- **승/무/패 금액(음수=차감 포함)을 어드민에서 설정**하고, 그 값이 **금고 적립/차감에 그대로 반영**되도록 정합성 확보.
- 기존에 숨어있던 **DICE 금고 하드코딩(예: +200/-50)** 및 **신규 유저 첫 LOSE +300 특수 규칙**을 제거/우선순위 조정하여 “설정값=실제 반영값”으로 통일.
- 주사위 플레이 결과에서 **금고 차감(음수)도 모달로 안내**되도록 UI 보완.

---

## 배경
운영자가 주사위 승/무/패 결과에 따른 경제(적립/차감)를 **어드민에서 일관되게 제어**하고 싶었으나,
- Frontend(Admin)에서는 금액을 설정할 수 있어도,
- Backend(Vault)에서 실제 금고 반영이 일부 하드코딩/특수 규칙에 의해 달라져,
"어드민 설정값"과 "유저 체감 결과"가 어긋나는 문제가 있었다.

또한 `reward_type=POINT` 등은 시스템 내 다른 의미 흐름이 있어 운영자 혼동 여지가 있어,
어드민 UI에서 “타입 vs 금액”의 의미를 분리해 안내할 필요가 있었다.

---

## 이번 변경

### 1) 주사위: 승/무/패 금액 음수 허용 + 운영자 가이드 (Frontend/Admin)
- 주사위 설정 화면에서 승/무/패 금액 입력에 **음수 허용**.
- 기본 reward_type을 **NONE**으로 두고, 운영자 혼동 방지를 위한 문구 추가:
  - “보상 타입은 보통 NONE 권장”
  - “금액은 금고 적립/차감(음수=차감)에 사용”

관련 파일
- src/admin/pages/DiceConfigPage.tsx

### 2) 주사위: 금고 적립/차감이 설정값을 우선 반영 (Backend)
- DICE 금고 반영 로직에서 `payout_raw.reward_amount`(=어드민에서 설정한 승/무/패 금액)를 **우선** 사용.
- 기존에 결과에 따라 섞여있던 하드코딩/특수 규칙을 제거하여,
  - 승/무/패 모두 **설정값(양수/0/음수)** 그대로 반영.

관련 파일
- app/services/vault_service.py

### 3) 주사위: 차감(음수)도 모달로 안내 (Frontend)
- 기존: `vaultEarn > 0`일 때만 “금고 적립” 모달 노출.
- 변경: **주사위에 한해** `vaultEarn !== 0`이면 모달 노출.
- 모달 표기도 음수 지원:
  - 양수: “금고 적립”, `+200원`
  - 음수: “금고 차감”, `-50원`

관련 파일
- src/pages/DicePage.tsx
- src/components/vault/VaultAccrualModal.tsx

---

## (함께 진행된) 운영 안정화/품질 개선
### 복권: 배민 기프티콘 즉시 지급 방지(지급대기)
- 즉시 비용 집행 대신, 인벤토리에 `BAEMIN_GIFTICON_<amount>` 형태로 적립(지급대기)하도록 처리.
- 어드민 저장 단계에서 기프티콘 금액을 `{5000, 10000, 20000}`으로 검증해 잘못된 설정을 사전 차단.

### Admin CRM: 잦은 변경으로 인한 스타트업 크래시 방지
- admin_crm 라우터 import 스모크 테스트 추가(컨테이너 스타트업 시점 크래시 조기 탐지 목적).

### KPI: `₩undefined` 표기 방지
- 마케팅 대시보드 KPI 포맷터를 안전하게 처리해 undefined/null일 때 `-` 표시.

---

## 검증
- Frontend build: `npm run build` 통과
- Backend 전체 테스트: `python -m compileall -q app` + `pytest -q` 통과 (125 passed)
- 주사위 금고 적립/차감 타깃 검증: `pytest -q tests/test_vault_earn_event_game.py` 통과

---

## 운영 가이드 (주사위)
- 주사위 설정에서 **reward_type은 NONE(권장)** 으로 두고,
- **승/무/패 금액**만 원하는 값으로 입력하면 금고에 그대로 반영됨.
  - 양수: 적립
  - 0: 변화 없음
  - 음수: 차감
