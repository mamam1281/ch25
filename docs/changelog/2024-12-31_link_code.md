# 개발 로그: Telegram Link Code 시스템 (2024-12-31)

## 변경 요약
Telegram `start_param` 길이 제한 문제를 해결하기 위해 JWT 기반 토큰 대신 **12자리 Base62 단축 코드** 시스템으로 전환.

---

## 주요 변경 파일

### [NEW] `app/models/telegram_link_code.py`
- `TelegramLinkCode` SQLAlchemy 모델 생성
- 컬럼: `code` (PK, 16자), `user_id`, `expires_at`, `used_at`, `created_at`, `client_ip`, `user_agent`

### [MODIFY] `app/api/routes/telegram.py`
- **`POST /link-token`**: 
  - 기존: `security.create_telegram_link_token()` → JWT 생성
  - 변경: `_generate_short_code(12)` → DB에 저장 → `link_<code>` 반환
  
- **`POST /auth`**:
  - 기존: `security.decode_telegram_link_token()` → JWT 검증 + User.nonce 검사
  - 변경: `TelegramLinkCode` 테이블 조회 (with `FOR UPDATE`) → `used_at` 마킹 → 연결

### [NEW] `scripts/create_telegram_link_code.sql`
- MySQL 테이블 생성 스크립트 (적용 완료)

---

## 보안 개선 사항
| 항목 | 기존 | 변경 후 |
|------|------|---------|
| 코드 길이 | ~200자 (JWT) | 12자 (Base62) |
| 저장소 | User.nonce 컬럼 | 별도 `telegram_link_code` 테이블 |
| 동시성 처리 | 없음 | `SELECT FOR UPDATE` 사용 |
| 사용 표시 | nonce 삭제 | `used_at` 타임스탬프 기록 |
| 만료 에러 | 400 Bad Request | 410 Gone (명확한 상태 코드) |

---

## 다음 단계 (미구현)
1. **Admin Merge Tool**: 중복 계정 병합 API 및 스크립트
2. **연결 해제 요청 워크플로우**: 409 충돌 시 사용자 자기주장 검증 절차
3. **Cleanup Job**: 만료된 미사용 코드 정리 배치

---

## 검증 항목
- [x] `telegram_link_code` 테이블 생성 확인 (MySQL)
- [ ] `/link-token` API 테스트 (짧은 코드 반환)
- [ ] `/auth` API 테스트 (코드 검증 및 연결)
- [ ] 만료/중복 사용 시나리오 테스트
