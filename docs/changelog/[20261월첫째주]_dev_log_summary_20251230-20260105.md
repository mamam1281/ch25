# 개발로그 종합 정리 (2025-12-30 ~ 2026-01-05)

## 분류
- 종결: 완료되어 재발 가능성 낮고, 배포/검증 끝난 항목
- 주의: 서로 영향을 끼치는 영역(동시 변경 시 충돌/회귀 가능)
- 연쇄이슈: 서로 영향 받아 이슈화된 사례(회고/교훈)

---
## 1) 종결된 것 (날짜별 핵심)
- 12/30 HTTPS·Nginx·텔레그램 복구: SSL 리다이렉트/443 설정, .env UTF-16LE→UTF-8, Alembic head 적용, `/api` 경로 정렬, 봇 토큰·MINI_APP_URL 재설정 → 서비스 접근/봇 응답 정상화.
- 12/31 텔레그램 링크 코드 단축화: JWT→12자리 코드, `telegram_link_code`/`telegram_unlink_request` 테이블, 링크/언링크 워크플로우 + Admin 머지툴 완성.
- 01/01 버그·QA 패치: 다이아 토스트 인코딩, 룰렛 패배 차감 복구, 복권 필드 매핑 수정, 팀배틀 시즌 충돌 해소, 미션 액션(JOIN_CHANNEL/SHARE_STORY) 추가, 502는 Nginx 재시작으로 복구.
- 01/02 회원 삭제 CASCADE: `vault_status` FK/로직 정비, 신규 회원 프로모션 모달 안정화(useRef, isVerifying, 토스트 이동), 깃 업스트림 재정렬.
- 01/02 Vault 단일 SoT Phase3: cash_balance 신규 write 차단, CASH_UNLOCK/VAULT_UNLOCK 전환 제거, cash→locked 마이그레이션 스크립트 준비.
- 01/03 DICE 금고 정합화: 승무패 금액(음수 포함) 설정값을 그대로 금고에 반영, 하드코딩 제거, 음수 차감 모달 노출; Admin 안내 문구 개선.
- 01/03 Ticket0 카피/UI 정리: 해금 안내 블록 삭제, 20레벨 기준으로 교정, UI/백엔드 카피 일치화.
- 01/04 Admin 대시보드 사고 복구: 레거시 `/metrics`/`/streak` 복원 후 신규 엔드포인트 병행, 테스트 추가.
- 01/04 세그먼트 추천 근거 노출: 추천 이유 문자열로 “왜 이 세그먼트인지” 표기.
- 01/05 미션/스트릭 E2E 스크립트: `debug_daily_login_gift.py`, `debug_streak_reward_claim.py` 배포(운영 설정 존중은 `--no-set-rule`).
- 01/05 Admin PURGE 하드닝: 레벨/XP, 세그먼트, VaultStatus purge 추가, `telegram_unlink_request` 미존재 시 테이블 체크 가드.

---
## 1-1) 2026-01-05 당일 이슈·조치 상세
- Admin PURGE 500 (prod DB): `telegram_unlink_request` 테이블 부재로 SQL 1146 터짐 → `has_table` 가드 추가, 레벨/XP·세그먼트·VaultStatus purge 확장, 재배포 완료.
- Streak/미션 실서버 검증 스크립트 배포: `debug_daily_login_gift.py`, `debug_streak_reward_claim.py`(운영 룰 준수는 `--no-set-rule`), day 1~7 수동 검증 가이드 배포.
- 주간 미션 auto_claim 혼선: auto_claim=True 미션을 수동 재클레임 시 "Already claimed"가 정상임을 재확인, 수동 테스트는 auto_claim=False 미션으로 안내.
- Admin purge 잔여 위험: 환경마다 없는 테이블 접근 가능성 → purge 실패 시 로그 보고 해당 테이블을 가드/삭제 목록에 추가해야 함.

## 1-2) 당일 이슈 ↔ 기존 이슈 연관성
- PURGE 500 ↔ 12/31 텔레그램 테이블: 링크/언링크 워크플로우에서 테이블이 선택적(환경별)로 도입된 역사 때문에, 1/5 prod DB에는 `telegram_unlink_request`가 없어 1146 발생. 교훈: 선택적 테이블 접근 시 항상 `has_table` 가드.
- Streak/데일리 검증 스크립트 ↔ 1/5 스크립트 배포 & 1/3~1/4 스트릭 리워크: 스트릭 보상 수동 클레임 전환 이후(1/3~1/4) 운영 룰 확인을 위해 실서버 검증 스크립트가 필요해짐 → 1/5 배포.
- 주간 미션 auto_claim 혼선 ↔ 1/1 미션 액션 확장: 미션 신규 액션 추가 후 auto_claim 설정이 섞여 있어 수동 테스트 시 혼선이 반복 → 1/5에 명확한 테스트 가이드 제시.
- PURGE 확장 대상 ↔ 1/2 CASCADE 보강/1/3 DICE 정합화/1/2 Vault 단일 SoT: 이후에 추가된 레벨/XP, 세그먼트, VaultStatus, 금고 이벤트 등 테이블이 계속 늘어 purge 누락 리스크 증가 → 1/5에 목록 확장 및 가드 적용.

## 2) 서로 영향을 끼치는 주의 포인트 (충돌/회귀 가능 구간)
- Vault 단일 SoT ↔ 보상 설계: cash_balance write 금지. 모든 신규 보상·미션·이벤트 지급은 `vault_locked_balance`만 사용. cash_balance를 만지면 회귀.
- 미션 auto_claim 플래그: `auto_claim=True`는 완료 즉시 클레임(재호출 시 Already claimed). 회귀 테스트는 `auto_claim=False` 대상로 분리.
- 텔레그램 링크/언링크 테이블 존재 여부: `telegram_unlink_request`는 환경별로 없을 수 있음. 스크립트·purge 호출 전 `has_table` 필수.
- DICE 금고: 승/무/패 금액(음수 포함) 설정값 그대로 반영. 하드코딩/특수 규칙 추가 시 설정-결과 불일치 발생.
- PURGE 순서와 대상: ledger → inventory/wallet → level_xp/segment → vault_status → user. 새 테이블 추가 시 purge 목록/순서 업데이트 필요.
- Admin 파일 수정 방식: 기존 파일 overwrite 금지. patch/append만 사용(대시보드 사고 재발 방지).
- Nginx/경로 정합성: `/api` 프리픽스, HTTPS 리다이렉트, 업스트림 이름이 어긋나면 프론트/봇 전체 장애.

## 3) 연쇄 영향으로 이슈화된 사례 (원인 → 결과 → 교훈)
- Nginx/HTTPS 미정비 → API 404/502 → 텔레그램·프론트 전체 불능 (12/30) → 배포 전 HTTPS/프록시 체크리스트 필수.
- Admin 대시보드 overwrite → 레거시 `/metrics`/`/streak` 삭제 위험 → 운영 지표 공백 (1/4) → 기존 파일은 patch/append만 사용.
- `telegram_unlink_request` 미존재 → PURGE 500 (1/5) → 환경마다 없는 테이블 접근 시 `has_table` 가드.
- 미션 24/26 멈춤 → NotificationService 토큰 오타가 트랜잭션 롤백 (1/1) → 알림 실패는 try-except로 격리.
- auto_claim 오인 → 이미 클레임된 주간 미션을 재호출하며 장애로 오인 (1/5) → auto_claim 플래그 구분해 테스트/운영.
- DICE 하드코딩 잔재 → 어드민 설정과 금고 반영 불일치 (과거) → 설정값 일원화 후 하드코딩 금지.

---
## 4) 재발 방지/운영 메모
- 배포 전 체크리스트: Nginx SSL/업스트림, `.env` 인코딩, alembic upgrade, `/api` 프리픽스 정합성.
- PURGE 실패 시: 최신 코드에 포함된 테이블 가드 사용 후에도 FK 에러가 나면 로그 보고 해당 테이블을 purge 목록에 추가.
- Streak/데일리 검증: 운영 설정을 존중하려면 `debug_streak_reward_claim.py --no-set-rule --day N` 사용. 데일리 선물은 `debug_daily_login_gift.py`로 인벤 증가 확인.
- Vault 마이그레이션: cash→locked 이관은 백업 후 dry-run → apply → dry-run 재확인 순서 준수.
내용이 