# 🎯 주사위 피크타임 이벤트(조건부 출금) 빌드 문서 (Draft)

작성일: 2026-01-04

## 0. 목표 / 한 줄 정의
- **30만원 충전 유저 대상**으로 피크타임(30분) 동안 주사위 플레이 결과로 금고 적립을 체감시키되,
- **즉시 출금 불가(잠금)** + **플레이 조건 충족 시에만 해제(조건부 출금)**로 비용을 통제한다.

## 1. 이벤트 UX(유저 관점)
### 1-1. 참여 조건
- 충전 트리거: **단일 충전 30만원**(외부 검증/어드민 입력 포함)
- 대상자 컷(예시, 서버 판별):
  - 최근 14일 내 충전 1회 이상 (`UserActivity.last_charge_at` 기반)
  - 누적 충전 3만원 이상 (`ExternalRankingData.deposit_amount` 기반)
  - 제외: `AdminUserProfile.tags`에 `Blacklist` 포함 유저

### 1-2. 지급/정산
- 충전 확인 시점에 **금고 잠금 적립 20,000원** 부여 (즉시 출금 불가)
- 피크타임 30분 동안 주사위 플레이 결과에 따라 금고 잠금 잔고가 **증가/감소**
- **주사위 30회 플레이 완료** 시에만 잠금 해제(출금 가능 상태로 전환)

### 1-3. “0이면 밑져야 본전” 방지(리스크가 실제로 발생하도록)
아래 중 하나를 선택(권장 순서):
1) **이벤트 모드 참여 조건으로 “이벤트 스테이크(잠금 잔고) 최소치” 요구**
   - 예: 이벤트 주사위는 시작 시점에 잠금 잔고(이벤트 스테이크) >= 2,000원일 때만 진입 가능
   - 스테이크가 0이 되면 이벤트 모드 진입 불가(= 바닥 본전 플레이 차단)
2) **미수금(음수) 허용(비권장)**
   - 현재 v1 금고는 음수로 내려갈 수 있어 “차감은 실제 발생”하나,
   - 유저 반발/CS/신뢰 리스크가 커서 기본 정책으로는 비권장

## 2. 공정성/신뢰 원칙(필수)
- (운영 선택) 본 이벤트는 **가상머니(금고 잠금 잔고) 기반 이벤트 모드**로, 서버가 이벤트 모드에서 **승/무/패 확률 및 페이테이블을 운영 파라미터로 관리**할 수 있다.
- 대신 아래 항목은 운영/CS 관점에서 반드시 고정·관리한다:
  - 이벤트 기간
  - 대상자 조건
  - 1일 상한(지급/손실)
  - 출금 조건(30회)
  - (선택) 승/패 시 적립/차감액 범위

## 3. 현재 코드/DB에서 가능한 것(팩트)
### 3-1. 충전/입금 판별 데이터
- 누적 입금액: `external_ranking_data.deposit_amount`
- 최근 충전 시각: `user_activity.last_charge_at`
  - 주의: 이 값은 “거래 로그”가 아니라 **external_ranking_data 갱신 시각(row.updated_at)**을 충전 시각으로 간주해 기록됨

### 3-2. 티켓(주사위 토큰) 출처 구분
- TRIAL(체험) 토큰 사용 여부는 `consumed_trial`로 판별 가능
- 그 외 “무료 지급 vs 구매”를 일반적으로 구분할 표준 필드는 현재 부족
  - 따라서 ‘일반 티켓 기준’이라는 조건은 **현 상태에선 ‘TRIAL 제외’ 정도만 강제 가능**

### 3-3. 금고 적립/차감 처리
- 금고 v1 잠금 잔고는 `User.vault_locked_balance`에 누적됨
- 게임 적립 이벤트는 `VaultService.record_game_earn_event()`가 담당
  - DICE의 승/패 기본값은 fallback 기준 WIN=200 / LOSE=-50
  - 배율은 `vault_accrual_multiplier()`를 통해 적용
- Vault2(프로그램/config)는 **운영용 설정 저장소로 활용 가능**
  - `VaultProgram.config_json.game_earn_config`로 DICE WIN/LOSE 값 운영 조정 가능

## 4. 구현 설계(권장 아키텍처)

### 4-1. 이벤트 상태(서버가 알아야 하는 최소 정보)
필수 상태:
- `event_id`: 예) `DICE_PEAK_202601`
- `user_id`
- `eligible`: 대상자 조건 통과 여부
- `session_window`: 시작/종료(피크타임 30분)
- `plays_required`: 30
- `plays_done`: 이벤트 기간 내 주사위 플레이 횟수
- `locked_grant_amount`: 20,000
- `stake_balance`: 이벤트 스테이크(잠금 잔고 내에서 추적)

저장 위치(선택지):
1) **Vault2 `VaultStatus.progress_json` 사용(추천)**
   - 이벤트 진행/횟수/상태를 JSON으로 저장
2) 별도 테이블 신설(확장성↑)

### 4-2. 지급(충전 트리거) 처리
- 트리거: “30만원 충전 확인” 시점
- 액션:
  1) 유저를 이벤트 eligible로 마킹
  2) 금고 잠금 잔고에 20,000원 추가(= 이벤트 스테이크 생성)
  3) 이벤트 진행 상태 초기화(plays_done=0 등)

주의:
- 외부 충전 검증이 현재 수동일 수 있으므로, **어드민 버튼/엔드포인트**로 트리거 가능해야 함

### 4-3. 플레이 횟수 카운팅
- 이벤트 기간 내 주사위 플레이가 발생할 때마다 `plays_done += 1`
- TRIAL 소비 플레이는 제외하고 싶다면:
  - `GameWalletService.require_and_consume_token()` 결과의 `consumed_trial`을 활용해 제외

### 4-4. 승/패 적립/차감(스테이크 기반)
- 이벤트 모드에서만 적용되는 별도 룰을 둔다:
- 이벤트 모드에서는 (A) **승/무/패 확률**과 (B) **승/무/패 금액(페이테이블)**을 함께 운영 파라미터로 둔다.

#### 4-4-1. 목표: “20,000원 시작 → 30회 후 평균 15,000원” (이벤트 모드)
- 목표 평균 최종 잔고가 15,000원이면, 30회 동안 평균으로는 **-5,000원** 정도 내려가면 된다.
  - 1회당 평균 변화는 대략 **-167원/회**

#### 4-4-2. 권장 페이테이블(2안)
- 기본(권장): **WIN=+1,200 / DRAW=-1,000 / LOSE=-1,320**
- 대안(조금 완화): **WIN=+1,100 / DRAW=-900 / LOSE=-1,250**

#### 4-4-3. 권장 확률 세팅(예시)
- 확률은 이벤트 모드에서 `p_win`, `p_draw`, `p_lose`로 설정하고, 매 판 결과를 **가중치 랜덤**으로 결정한다.
- 30회 평균 15,000원을 목표로 할 때의 예시(운영 중 미세 조정 가능):
  - 기본(권장 페이테이블 사용 시): `p_draw=0.11`, `p_win≈0.444`, `p_lose≈0.446`
  - 대안(완화 페이테이블 사용 시): `p_draw=0.11`, `p_win≈0.445`, `p_lose≈0.445`

#### 4-4-4. 구현 포인트(확률 조작 방식)
- 결과(outcome)를 먼저 가중치로 결정한 뒤, 그 결과에 맞는 주사위 눈을 생성한다.
  - 예: outcome=WIN이면 사용자 합이 딜러 합보다 크게 나오도록 눈을 생성
  - outcome=DRAW이면 합이 같도록 눈을 생성
- 이렇게 하면 “주사위 값”은 항상 정상 범위(1~6)로 보이면서도, 이벤트 모드의 목표 평균을 안정적으로 맞출 수 있다.
- 분포(체감) 관점:
  - 15명이면 0원/5천/2만/3만/4만처럼 **다양하게** 갈 수 있다.
  - 또한 운영 목적에 따라 **유저별로 핸들링 정책(확률/페이테이블/상한)을 다르게** 적용할 수 있다.
  - 그래서 상한(+20,000)과 바닥(스테이크 0 중단)을 같이 두면 비용과 리스크를 더 안정적으로 제어 가능.

#### 4-4-5. 유저별 핸들링(태그/세그먼트 기반)
- 기준: **`AdminUserProfile.tags`에 `Blacklist` 포함 여부 1가지로만 처리**
- 정책(권장): `Blacklist` 유저는 **이벤트 모드 진입 차단**(= 이벤트 확률/페이테이블 적용 대상에서 제외)
  - 운영/CS 문구: “부정 이용 방지 정책에 따라 일부 계정은 이벤트 대상에서 제외될 수 있음”
- 데이터 소스(현재 코드/DB에 존재): `AdminUserProfile.tags`
- 구현 포인트:
  - `DiceService.play()`에서 이벤트 모드 적용 전 `AdminUserProfile.tags`에 `Blacklist`가 있으면 이벤트 모드 스킵
  - 운영 변경은 추적 가능하도록 감사 로그(어드민 변경 이력) 권장
- 비용 통제:
  - 1일 최대 플레이 수(예: 30회)
  - 1일 최대 순증(예: +20,000 상한)
    - 정의(권장): **게임 플레이로 인해 증가한 잠금 잔고의 순증분** 상한
    - 해석(질문 답): 시작 스테이크가 20,000원일 때, “순증 +20,000”이면 **이벤트로 최대 +20,000까지 더 벌 수 있음**
      - 즉, 잠금 잔고가 이 이벤트 때문에 최대 **40,000(=20,000+20,000)**까지 커질 수 있다는 의미
      - 만약 “20,000 시작해서 20,000 도달하면 종료(총액 상한 20,000)”를 원하면, 상한을 **‘총 잠금 잔고 상한’**으로 별도 정의해야 함
    - 동작(예시): 상한 도달 시 이벤트 모드 적립을 0으로 클램프하거나, 이벤트 모드 자체를 종료
  - 스테이크가 0이면 이벤트 모드 중단

### 4-5. 잠금 해제(출금 가능 전환)
- 조건: `plays_done >= plays_required`
- 액션:
  - 잠금 금액(이벤트 스테이크 잔고)을 “출금 가능 상태”로 전환

현재 코드 베이스 기준 힌트:
- Vault2에는 LOCKED/AVAILABLE 상태가 있으나, 게임플레이에 완전 연결되어 있지 않음
- 단기 구현은 v1(User.vault_locked_balance / available mirror)와 Vault2(북키핑)를 함께 쓰는 형태가 현실적

## 5. 운영 파라미터(초기 권장값)
- 피크타임: 30분
- 대상자:
  - 최근 14일 충전 1회 이상
  - 누적 30,000원 이상
  - (가능하면) 이벤트 트리거는 “30만원 충전” 단일 조건
- 플레이 조건: 30회
- 스테이크:
  - 잠금 지급 20,000
  - WIN/LOSE 예시: +1,000 / -1,000 (또는 +2,000 / -2,000)
- 상한:
  - 1일 1회 참여(이벤트 트리거 기준)
  - 1일 최대 플레이 30회
  - 1일 최대 순증 +20,000

## 6. 리스크 & 방어
- “꽁머니 티켓 보유자”가 이벤트 보너스를 먹는 문제
  - 해결: 티켓 보유 여부가 아니라 **충전/입금 데이터 기반**으로 eligible 컷
  - TRIAL 제외는 가능(완전 무료/프로모 구분은 현재 한계)
- 비용 폭주
  - 상한(횟수/순증) + 잠금/조건부 출금 + 대상자 컷
- 신뢰/여론
  - 이벤트 모드의 파라미터(확률/페이테이블)는 운영 변경 이력이 남도록 관리(어드민 감사 로그 권장)

## 7. 모니터링/지표
- 참여자 수(eligible 중 실제 플레이)
- 30분 피크타임 동시접속/플레이 수
- 1인 평균 플레이 수
- 1인 평균 순증(잠금 잔고 변동)
- 출금 해제율(조건 달성률)
- CS 이슈(“왜 출금이 안 되냐/조건이 뭐냐”)

## 8. 롤백 플랜
- 즉시 중단:
  - Vault 배율 OFF
  - 이벤트 모드 진입 차단
- 정산:
  - 진행 중 유저의 스테이크/잠금 잔고는 “정책에 따라” 유지/회수/부분 환급(사전 고지 필요)

---

## 부록 A. 관련 코드(참조)
- 금고 게임 적립/차감: `VaultService.record_game_earn_event()`
- 배율: `VaultService.vault_accrual_multiplier()`
- 누적 입금: `ExternalRankingData.deposit_amount`
- 최근 충전: `UserActivity.last_charge_at` (external_ranking_data 갱신 기반)
- TRIAL 사용 여부: `GameWalletService.require_and_consume_token()` → `consumed_trial`
