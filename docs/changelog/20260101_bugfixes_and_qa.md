# 2026-01-01 버그 수정 및 QA 리포트

## 요약
사용자 피드백으로 접수된 8가지 항목(버그 수정 4건, 로직 검증 4건)에 대한 처리를 완료했습니다.

## 버그 수정 내역

### 1. 다이아몬드 지급 토스트 메시지 인코딩 수정
- **증상**: 미션 보상 수령 시 토스트 메시지가 깨져서 출력됨 ("ë³´ìƒ...").
- **원인**: `MissionCard.tsx` 내 하드코딩된 문자열의 인코딩 문제.
- **조치**: 깨진 문자열을 올바른 한글("보상 수령 완료", "보상 수령 실패")로 수정하였습니다.

### 2. 룰렛 게임 차감 로직 수정
- **증상**: 룰렛 게임 패배(꽝/Segment 5) 시 볼트 잔액이 차감되지 않음 (-50원 미적용).
- **원인**: `VaultService`에서 주사위(DICE) 외 게임은 기본적으로 승리(+200)로 간주하는 로직의 허점.
- **조치**: `ROULETTE` 게임 타입에 대해 보상액이 0인 경우 패배로 간주하여 -50원을 차감하도록 로직을 추가했습니다.

### 3. 관리자 복권 설정 저장 오류 수정
- **증상**: 복권 설정에서 '일일 플레이 제한'을 설정해도 저장 후 1로 초기화됨.
- **원인**: 백엔드 DB 모델(`max_daily_tickets`)과 API 스키마(`max_daily_plays`) 간의 필드명 불일치.
- **조치**: Pydantic 스키마에 `validation_alias="max_daily_tickets"`를 추가하여 매핑을 정상화했습니다.

### 4. 팀 배틀 생성 실패 수정
- **증상**: 새 시즌 생성 시 "ACTIVE_SEASON_CONFLICT" 오류 발생.
- **원인**: 이미 종료된 과거 시즌(ID 2)이 DB 상에서 여전히 `is_active=True`로 남아있어 충돌 발생.
- **조치**: DB 스크립트를 통해 해당 시즌을 비활성화 처리하여 새 시즌 생성이 가능하도록 조치했습니다.

## 로직 검증 및 Q&A

### 5. 볼트 출금 최소 금액
- **질문**: 10,000원 이상만 출금 가능한가요?
- **확인**: **네**, 코드 상 하드코딩된 최소 출금액이 10,000원으로 설정되어 있습니다.

### 6. 게임 플레이 제한
- **질문**: 계정당 게임 횟수 제한이 있나요?
- **확인**: **아니오**, 현재 룰렛과 주사위 모두 `0`(무제한)으로 설정되어 있습니다.

### 6. 타임존 설정 확인
- **질문**: 모든 시스템이 한국 시간(KST)으로 잘 동작하나요?
- **확인**: Docker 컨테이너(Backend, DB, Redis, Nginx) 모두 `TZ=Asia/Seoul`로 설정되어 있으며, 로그 시간도 KST로 정상 출력됨을 확인했습니다.

---

## 3차 긴급 수정 및 트러블슈팅 (저녁 작업분)

### 1. 미션 시스템 고도화
- **채널 구독 및 친구 공유 미션 지원**:
  - **Admin UI**: 미션 생성 시 `Action Type` 드롭다운에 `JOIN_CHANNEL`(채널 구독) 및 `SHARE_STORY`(스토리 공유) 옵션이 누락된 문제를 수정했습니다.
  - **환경 변수**: 채널 구독 인증을 위한 `TELEGRAM_CHANNEL_USERNAME` 설정을 `.env`에 추가했습니다.
  - **인증 로직**: 텔레그램 봇 API를 통해 사용자의 채널 멤버십을 검증하는 로직(`/api/viral/verify/channel`) 연동을 준비했습니다.

### 2. 502 Bad Gateway 오류 트러블슈팅
- **증상**: `/admin/api/users/` 등 백엔드 API 호출 시 502 Bad Gateway 오류 지속 발생.
- **진단**:
  - `xmas-backend` 및 `xmas-telegram-bot` 로그 확인 결과, 서비스는 `200 OK`를 반환하며 정상 작동 중임.
  - 봇 재빌드 과정에서 Nginx의 Upstream 연결 풀이 유효하지 않게 되어 연결 거부 발생.
- **조치**: Nginx 컨테이너 재시작(`docker compose restart nginx`)을 통해 Upstream 연결을 초기화하고 문제를 해결했습니다.

### 3. 관리자 승인 시스템 (Friend Share)
- **현황**: `requires_approval` 필드는 DB에 존재하나, 관리자 패널 내 승인 처리 UI 및 API가 미구현 상태임.
- **대안**: 우선 `SHARE_STORY` 및 `SHARE_WALLET`은 클라이언트/봇 연동을 통한 신뢰 기반(Trust-based) 자동 완료 처리로 운영하고, 추후 어뷰징 방지가 필요할 시 승인 시스템을 도입하기로 함.

### 7. 지민 코드 지갑 미션 인증
- **질문**: "지민 코드 지갑 공유" 미션은 어떻게 인증하나요?
- **답변**: 현재 텍스트나 이미지 제출 기능이 없으므로, **"링크 열기(Link Action)"** 방식을 사용하여 사용자가 해당 페이지를 방문하면 자동 완료되도록 설정하는 것을 권장합니다. 철저한 검증이 필요하다면 관리자 수동 승인(`requires_approval=True`)을 켜야 하지만, 현재 승인 UI보다 자동 완료가 사용자 경험상 좋습니다.

### 8. 인벤토리(가방) 구현
- **상태**: 다이아몬드 키 등을 확인할 수 있는 인벤토리 기능은 현재 구현되어 있지 않으며, 추후 개발 예정 사항입니다.

---

## 2차 개발 및 수정 사항 (오후 작업분)

### 1. 인벤토리 & 상점 시스템 구현
- **백엔드**:
  - `InventoryService` 구현: 아이템 지급/사용, 토큰 소비/지급의 원자성(Atomicity) 보장 (auto_commit 도입).
  - API 라우트 (`/api/inventory`, `/api/shop`) 및 데이터 모델(`UserInventory`, `InventoryItem`) 추가.
- **프론트엔드**:
  - `InventoryPage`: 보유 아이템(바우처) 및 재화(티켓/코인/키) 통합 조회 UI 구현.
  - `ShopPage`: 상품 목록 조회 및 구매 기능 구현.

### 2. 시즌 패스 밸런스 조정
- **배경**: 레벨 20 달성 기준 금액이 너무 높다는 피드백 (기존 15억 KRW 상당).
- **조치**: 스탬프당 XP 효율을 5배 상향하고, 요구 XP 총량을 대폭 하향 조정.
  - 레벨 20 기준: 300,000 XP → **6,000 XP** (약 3,000만원 KRW 입금 기준).
  - `scripts/update_season_pass_20.py` 실행 완료.

### 3. 버그 수정 및 UI 개선
- **관리자 UI**: 볼트 현황 상세 조회 시 유저 식별 강화를 위해 `telegram_username` 필드 추가.
- **금고(Vault) UI**: '출금 신청' 버튼 추가.
  - 조건: 보유 캐시(Cash Balance) 10,000원 이상 시 버튼 노출.
- **룰렛 로딩 오류(멈춤 현상)**:
  - **원인**: 기본 룰렛(ID:1)의 세스먼트 설정이 소실되어(0개) 클라이언트가 무한 로딩에 빠짐.
  - **조치**: `scripts/seed_default_roulette.py` 실행하여 기본 세그먼트(100/200/500/꽝/1000/잭팟) 복구.
- **게임 및 주사위 검증**:
  - 룰렛/주사위 50회 연속 플레이 테스트 완료 (무제한 플레이 정상 작동 확인).
  - 주사위 오류("배틀 준비 중...")는 일시적 통신 문제일 가능성 높음(백엔드 로직 정상).

### 4. 미션 진행도 24/26 멈춤 오류 수정 (Critical)
- **증상**: "코드지갑 게임 26회" 미션 수행 중 24회에서 게임 로딩 오류 발생 및 진행도 멈춤.
- **원인**: 25회 진입 시 발생하는 '응원 알림(Nudge)' 로직에서 심각한 오류 발생.
  - `NotificationService` 초기화 시 오타(`TELEGRAM_BOT_TOKEN`)로 인한 속성 접근 에러.
  - 해당 에러가 게임 트랜잭션을 롤백시켜 게임 실행 자체가 실패함.
- **조치**:
  - `NotificationService.py` 내 변수명 수정.
  - `MissionService.py` 알림 발송 로직에 예외처리(`try-except`) 추가하여 알림 실패가 게임 진행을 막지 않도록 안전장치 마련.

### 5. 502 Bad Gateway 및 인벤토리 라우팅 오류 수정 (Critical)
- **증상**: `/api/auth/token` 502 응답 및 `/api/inventory` 등 인벤토리 관련 API 404 Not Found.
- **원인**: 
  - 신규 추가된 `inventory_shop` 라우터가 `/api` 프리픽스 없이 등록되어, 클라이언트(/api/inventory) 요청이 백엔드(/inventory)와 매칭되지 않음(404).
  - 해당 모듈 로딩 및 초기화 과정의 불안정성(또는 클라이언트의 잘못된 경로 재시도 폭주)이 Nginx와의 연결 문제(502)를 유발했을 가능성.
- **조치**: 
  - `app/api/routes/__init__.py`에서 `inventory_shop` 라우터 등록 시 `prefix="/api"`를 명시적으로 추가하여 경로 매칭 문제 해결.
  - Nginx 컨테이너 재시작을 통해 업스트림 연결 및 캐시 초기화 진행.



